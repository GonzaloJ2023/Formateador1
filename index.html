import React, { useState } from 'react';

const App = () => {
    // Definimos el estado para manejar los archivos, mensajes y resultados.
    const [uploadedFile, setUploadedFile] = useState(null);
    const [formatText, setFormatText] = useState('');
    const [statusMessage, setStatusMessage] = useState('');
    const [isError, setIsError] = useState(false);
    const [isSuccess, setIsSuccess] = useState(false);
    const [htmlPreview, setHtmlPreview] = useState('');
    const [docxBase64, setDocxBase64] = useState('');
    const [isProcessing, setIsProcessing] = useState(false);

    // URL del backend en Render
    const API_URL = 'https://formateador-de-web-app.onrender.com/process-document';

    // Maneja la selección del archivo.
    const handleFileChange = (event) => {
        const file = event.target.files[0];
        if (file && file.name.endsWith('.docx')) {
            setUploadedFile(file);
            setStatusMessage('');
            setIsError(false);
            setIsSuccess(false);
            setHtmlPreview('');
            setDocxBase64('');
        } else {
            setUploadedFile(null);
            setStatusMessage('Por favor, selecciona un archivo .docx válido.');
            setIsError(true);
            setIsSuccess(false);
        }
    };

    // Maneja el clic en el botón de procesamiento.
    const handleProcessClick = async () => {
        if (!uploadedFile) {
            setStatusMessage('Por favor, sube un archivo .docx primero.');
            setIsError(true);
            return;
        }

        setIsProcessing(true);
        setStatusMessage('Procesando, por favor espera...');
        setIsError(false);
        setIsSuccess(false);
        setHtmlPreview('');
        setDocxBase64('');

        const formData = new FormData();
        formData.append('file', uploadedFile);
        formData.append('format_text', formatText);

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Error desconocido del servidor.');
            }

            const result = await response.json();
            
            setHtmlPreview(result.html_content);
            setDocxBase64(result.docx_base64);
            setStatusMessage('¡Procesamiento completado!');
            setIsSuccess(true);
        } catch (error) {
            setStatusMessage(`Error: ${error.message}`);
            setIsError(true);
        } finally {
            setIsProcessing(false);
        }
    };

    // Maneja el clic en el botón de descarga.
    const handleDownloadClick = () => {
        if (!docxBase64) {
            setStatusMessage('No hay documento para descargar.');
            setIsError(true);
            return;
        }

        try {
            const byteCharacters = atob(docxBase64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });

            const downloadUrl = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = 'documento_corregido.docx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(downloadUrl);
            setStatusMessage('¡Descarga iniciada! Revisa tu carpeta de descargas.');
            setIsSuccess(true);
        } catch (error) {
            setStatusMessage(`Error al descargar el archivo: ${error.message}`);
            setIsError(true);
        }
    };

    return (
        <div className="bg-gray-900 text-gray-100 p-8 min-h-screen flex items-center justify-center">
            <script src="https://cdn.tailwindcss.com"></script>
            <div className="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-4xl w-full flex flex-col items-center space-y-8">
                <div className="flex items-center space-x-4">
                    <svg className="w-10 h-10 text-blue-500" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M14 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM12 11V13H8V11H12ZM16 15V17H8V15H16Z"/>
                    </svg>
                    <h1 className="text-4xl font-bold text-center">Procesador de Documentos Word</h1>
                </div>

                <div className="w-full flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                    <label htmlFor="file-upload" className="flex items-center px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg cursor-pointer hover:bg-blue-600 transition-colors duration-300">
                        <svg className="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Elegir Archivo .docx
                    </label>
                    <input id="file-upload" type="file" className="hidden" accept=".docx" onChange={handleFileChange} />
                    <span className="text-gray-400 italic mt-2 md:mt-0">{uploadedFile ? uploadedFile.name : 'Ningún archivo seleccionado'}</span>
                </div>

                <div className="w-full">
                    <label htmlFor="format-text" className="block text-lg font-semibold mb-2">Ingresa el texto a remover (opcional):</label>
                    <textarea 
                        id="format-text" 
                        className="w-full p-4 bg-gray-700 rounded-lg text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        rows="3" 
                        placeholder="Ej: Escribe 'Confidencial' para remover todos los párrafos que contengan esa palabra."
                        value={formatText}
                        onChange={(e) => setFormatText(e.target.value)}
                    ></textarea>
                </div>

                <button 
                    onClick={handleProcessClick}
                    className="w-full md:w-1/2 p-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition-colors duration-300 transform active:scale-95 disabled:bg-gray-600 disabled:cursor-not-allowed"
                    disabled={isProcessing}
                >
                    {isProcessing ? (
                        <>
                            <svg className="w-6 h-6 inline-block mr-2 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M12 2v4"></path><path d="M12 18v4"></path><path d="M4.93 4.93l2.83 2.83"></path><path d="M16.24 16.24l2.83 2.83"></path><path d="M2 12h4"></path><path d="M18 12h4"></path><path d="M4.93 19.07l2.83-2.83"></path><path d="M16.24 7.76l2.83-2.83"></path>
                            </svg>
                            Procesando...
                        </>
                    ) : (
                        <>
                            <svg className="w-6 h-6 inline-block mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M21 2L14 9l-7 7-5 5L2 19l5-5 7-7 7-7z"></path>
                            </svg>
                            Procesar Documento
                        </>
                    )}
                </button>

                {statusMessage && (
                    <div className="w-full text-center">
                        <p className={`text-lg font-medium p-4 rounded-lg ${isError ? 'bg-red-700 text-red-200' : isSuccess ? 'bg-green-700 text-green-200' : 'bg-yellow-700 text-yellow-200'}`}>
                            {isError && (
                                <svg className="w-6 h-6 inline-block mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>
                                </svg>
                            )}
                            {isSuccess && (
                                <svg className="w-6 h-6 inline-block mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-8.66"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                            )}
                            {statusMessage}
                        </p>
                    </div>
                )}
                
                {htmlPreview && (
                    <div className="w-full space-y-6">
                        <div>
                            <h2 className="text-2xl font-bold mb-4">Previsualización del Documento Procesado</h2>
                            <div className="bg-gray-700 rounded-lg p-6 max-h-96 overflow-y-auto">
                                <div dangerouslySetInnerHTML={{ __html: htmlPreview }} />
                            </div>
                        </div>

                        <div className="flex justify-center">
                            <button 
                                onClick={handleDownloadClick}
                                className="px-10 py-4 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg shadow-lg transition-colors duration-300 transform active:scale-95"
                            >
                                <svg className="w-6 h-6 inline-block mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                Descargar Documento Procesado
                            </button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

export default App;
